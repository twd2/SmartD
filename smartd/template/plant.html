{% extends 'base.html' %}
{% block body %}
<div class="page-header">
  <h1>Plant</h1>
</div>
<div class="row">
  <div class="col-sm-12">
    <div class="panel panel-success">
      <div class="panel-heading">
        <h3 class="panel-title">Realtime Video</h3>
      </div>
      <div class="panel-body">
        Not Implemented
      </div>
    </div>
  </div>
  <div class="col-sm-6">
    <div class="panel panel-success">
      <div class="panel-heading">
        <h3 class="panel-title">Soil Humidity</h3>
      </div>
      <div class="panel-body">
        {% module Template('panel.html', type='humidity', unit='%', doc=humidity) %}
      </div>
    </div>
    <div class="panel panel-success">
      <div class="panel-heading">
        <h3 class="panel-title">Temperature</h3>
      </div>
      <div class="panel-body">
        {% module Template('panel.html', type='temperature', unit='Â°C', doc=temperature) %}
      </div>
    </div>
  </div>
  <div class="col-sm-6">
    <div class="panel panel-success">
      <div class="panel-heading">
        <h3 class="panel-title">Light</h3>
      </div>
      <div class="panel-body">
        {% module Template('panel.html', type='light', unit='', doc=light) %}
      </div>
    </div>
    <div class="panel panel-success">
      <div class="panel-heading">
        <h3 class="panel-title">Water Tank</h3>
      </div>
      <div class="panel-body">
        {% module Template('panel.html', type='tank', unit='cm', doc=tank) %}
      </div>
    </div>
  </div>
</div>
    <script type="text/javascript">
      function render_chart($obj, data)
      {
        $obj.highcharts({
          title: {
            text: null
          },
          legend: {
            enabled: false
          },
          credits: {
            enabled: false
          },
          xAxis: {
            categories: data['x']
          },
          yAxis: {
            title: {
              text: null
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
          },
          tooltip: {
            valueSuffix: null
          },
          series: [{
            name: 'Value',
            data: data['y']
          }]
        });
      }

      var category = 'plant';

      var ws_url = 'ws';
      if (window.location.protocol == 'https:')
      {
        ws_url += 's';
      }
      ws_url += '://' + window.location.host;

      var ws = new WebSocket(ws_url + '/plant-ws');
      ws.onopen = function() {
         // todo: auth
      };
      
      ws.onmessage = function (msg) {
         var e = JSON.parse(msg.data);
         if (e['event'] == 'updated')
         {
           console.log(msg.data);
           $.getJSON('/data/' + category + '/' + e['type'], function (obj) {
             if (obj['x'].length > 0)
             {
               render_chart($('#container-' + e['type']), obj);
               $('#' + e['type'] + '-value').text(obj['y'][obj['y'].length - 1]);
               $('#' + e['type'] + '-datetime').text('(at ' + obj['x'][obj['x'].length - 1] + ')');
             }
           });
         }
      };
		</script>
  <script src="{{ static_url('hc/js/highcharts.js') }}"></script>
  <script src="{{ static_url('hc/js/modules/exporting.js') }}"></script>
{% end %}
